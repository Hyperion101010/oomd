<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=edge"/><title>oomd at Facebook · oomd</title><meta name="viewport" content="width=device-width"/><meta name="generator" content="Docusaurus"/><meta name="description" content="Sandcastle is an internal system that builds, tests, and lands code, and is one of the largest services running at Facebook. "/><meta name="docsearch:language" content="en"/><meta property="og:title" content="oomd at Facebook · oomd"/><meta property="og:type" content="website"/><meta property="og:url" content="https://facebook.github.io/oomd/index.html"/><meta property="og:description" content="Sandcastle is an internal system that builds, tests, and lands code, and is one of the largest services running at Facebook. "/><meta property="og:image" content="https://facebook.github.io/oomd/img/docusaurus.png"/><meta name="twitter:card" content="summary"/><meta name="twitter:image" content="https://facebook.github.io/oomd/img/docusaurus.png"/><link rel="shortcut icon" href="/oomd/img/oomd_fullcolor.png"/><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css"/><script type="text/javascript" src="https://buttons.github.io/buttons.js"></script><link rel="stylesheet" href="/oomd/css/main.css"/></head><body class="sideNavVisible separateOnPageNav"><div class="fixedHeaderContainer"><div class="headerWrapper wrapper"><header><a href="/oomd/"><img class="logo" src="/oomd/img/oomd_light.svg" alt="oomd"/><h2 class="headerTitleWithLogo">oomd</h2></a><div class="navigationWrapper navigationSlider"><nav class="slidingNav"><ul class="nav-site nav-site-internal"><li class="siteNavGroupActive"><a href="/oomd/docs/overview.html" target="_self">Docs</a></li><li class=""><a href="https://github.com/facebookincubator/oomd" target="_self">GitHub</a></li></ul></nav></div></header></div></div><div class="navPusher"><div class="docMainWrapper wrapper"><div class="container docsNavContainer" id="docsNav"><nav class="toc"><div class="toggleNav"><section class="navWrapper wrapper"><div class="navBreadcrumb wrapper"><div class="navToggle" id="navToggler"><i></i></div><h2><i>›</i><span>Get Started</span></h2><div class="tocToggler" id="tocToggler"><i class="icon-toc"></i></div></div><div class="navGroups"><div class="navGroup"><h3 class="navGroupCategoryTitle">Get Started</h3><ul><li class="navListItem"><a class="navItem" href="/oomd/docs/overview.html">Overview of oomd</a></li><li class="navListItem navListItemActive"><a class="navItem" href="/oomd/docs/oomd-casestudy.html">Case study: oomd at Facebook</a></li></ul></div></div></section></div><script>
            document.addEventListener('DOMContentLoaded', function() {
              createToggler('#navToggler', '#docsNav', 'docsSliderActive');
              createToggler('#tocToggler', 'body', 'tocActive');

              const headings = document.querySelector('.toc-headings');
              headings && headings.addEventListener('click', function(event) {
                if (event.target.tagName === 'A') {
                  document.body.classList.remove('tocActive');
                }
              }, false);

              function createToggler(togglerSelector, targetSelector, className) {
                var toggler = document.querySelector(togglerSelector);
                var target = document.querySelector(targetSelector);

                toggler.onclick = function(event) {
                  event.preventDefault();

                  target.classList.toggle(className);
                };
              }
            });
        </script></nav></div><div class="container mainContainer"><div class="wrapper"><div class="post"><header class="postHeader"><h1 class="postHeaderTitle">oomd at Facebook</h1></header><article><div><span><p>Sandcastle is an internal system that builds, tests, and lands code, and is one of the largest services running at Facebook.</p>
<p>The Sandcastle team's servers were running out of memory and their jobs were getting repeatedly OOM-killed. About 5% of Sandcastle hosts rebooted unexpectedly every day. Scaling Sandcastle by simply adding new servers was no longer a possibility due to the crunch on hardware resources.</p>
<h2><a class="anchor" aria-hidden="true" id="the-problem-unreleased-memory-and-arbitrary-kernel-oom-kills"></a><a href="#the-problem-unreleased-memory-and-arbitrary-kernel-oom-kills" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>The problem—unreleased memory and arbitrary kernel OOM kills</h2>
<p>Sandcastle machines use Tupperware, Facebook's in-house containerization solution, to run worker tasks that repeatedly fetch build jobs from a queue and run them. Sandcastle was using memory from <code>tmpfs</code> (an in-memory temporary filesystem) for the build jobs. When the build processes were killed they didn’t release their memory because the system’s <code>tmpfs</code> was bind mounted to each worker.</p>
<p style="margin-top: 1.3em"></p>
<div style="text-align: center;"><img src = "/oomd/docs/assets/sandcastle-before.png"/></div> 
<p style="margin-top: 1.3em"></p>
Another complication was that the kernel OOM killer would kill just one of a build job’s processes. Since the build job can't function without the dead process, it’s left in an undefined state. In such cases, all running jobs must be canceled and retried, taking nearly an hour before the host is up again.
<h2><a class="anchor" aria-hidden="true" id="the-solution-controlled-cgroup-oom-kills-with-oomd"></a><a href="#the-solution-controlled-cgroup-oom-kills-with-oomd" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>The solution—controlled cgroup OOM kills with oomd</h2>
<p>The team wanted to create a <a href="https://facebookmicrosites.github.io/cgroup2/">cgroup</a> architecture with the following objectives:</p>
<ul>
<li>Make OOM kills immediately free the <code>tmpfs</code> space the build job was using.</li>
<li>Make OOM kills kill an entire build job, instead of just one process within it.</li>
</ul>
<p>Experiments and testing led the team to the following solution:</p>
<ol>
<li>The worker contains each build job it runs inside its own sub-cgroup. All the build job processes are contained in their own cgroup in <code>workload.slice</code>.</li>
<li>oomd is configured to watch per-job cgroups.</li>
<li>Each build job gets its own mount namespace and <code>tmpfs</code> mount, instead of living off the worker’s mount namespace and bind mounting the system’s <code>tmpfs</code>.</li>
</ol>
<p style="margin-top: 1.3em"></p>
<div style="text-align: center;"><img src = "/oomd/docs/assets/sandcastle-after.png"/></div> 
<p style="margin-top: 1.3em"></p>
<p>With each build job contained in its own cgroup with oomd enabled, oomd kills the entire cgroup and all its processes at once.</p>
<p>Because the mount namespace is only pinned by the processes in that cgroup, the mount namespace gets released, which in turn frees the <code>tmpfs</code> instance the build job was using.</p>
<p>Tupperware no longer needs to clean up the task and restart it, since only the build job is killed instead of the worker itself. The Sandcastle worker notices the build job terminated abnormally and moves on to fetching the next job as quickly as it can.</p>
<h2><a class="anchor" aria-hidden="true" id="oomd-in-action"></a><a href="#oomd-in-action" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>oomd in action</h2>
<p>The chart below shows a real-world Sandcastle memory usage spike.</p>
<div style="text-align: center;"><img src = "/oomd/docs/assets/scuba-chart.png"/></div> 
<p>The corresponding <em>oomd</em> output log (located in <code>/var/log/messages</code>) shows the Sandcastle build job getting killed as a result of the spike in memory pressure:</p>
<div style="text-align: center;"><img src = "/oomd/docs/assets/oomd-output.png"/></div> 
<h2><a class="anchor" aria-hidden="true" id="results"></a><a href="#results" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Results</h2>
<p>This solution resulted in a big impact win for the Sandcastle team: since implementing <em>oomd</em>, the unexpected server reboot rate dropped from 5% to less than 0.5%. Post-OOM downtimes for Sandcastle machines went from tens of minutes to just seconds, driving a 10% capacity gain.</p>
<p>The increased reliability also significantly increased utilization, with a 35% increase in build jobs per host.</p>
</span></div></article></div><div class="docs-prevnext"><a class="docs-prev button" href="/oomd/docs/overview.html">← Overview of oomd</a></div></div></div><nav class="onPageNav"><ul class="toc-headings"><li><a href="#the-problem-unreleased-memory-and-arbitrary-kernel-oom-kills">The problem—unreleased memory and arbitrary kernel OOM kills</a></li><li><a href="#the-solution-controlled-cgroup-oom-kills-with-oomd">The solution—controlled cgroup OOM kills with oomd</a></li><li><a href="#oomd-in-action">oomd in action</a></li><li><a href="#results">Results</a></li></ul></nav></div><footer class="nav-footer" id="footer"><section class="sitemap"><a href="/oomd/" class="nav-home"></a></section><a href="https://code.facebook.com/projects/" target="_blank" rel="noreferrer noopener" class="fbOpenSource"><img src="/oomd/img/oss_logo.png" alt="Facebook Open Source" width="170" height="45"/></a><section class="copyright">Copyright (c) 2018 Facebook Inc. </section></footer></div></body></html>